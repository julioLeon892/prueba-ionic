rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isNonEmptyString(value, maxLength) {
      return value is string && value.size() > 0 && value.size() <= maxLength;
    }

    function isNullableString(value, maxLength) {
      return value == null || (value is string && value.size() <= maxLength);
    }

    function isValidCategory(data) {
      return data.keys().hasOnly(['name', 'color']) &&
        isNonEmptyString(data.name, 120) &&
        isNullableString(data.color, 7);
    }

    match /categories/{categoryId} {
      allow read: if true;
      allow create: if isValidCategory(request.resource.data);
      allow update: if isValidCategory(request.resource.data);
      allow delete: if true;
    }

    function isValidTask(data) {
      return data.keys().hasOnly(['title', 'completed', 'categoryId', 'createdAt', 'updatedAt']) &&
        isNonEmptyString(data.title, 200) &&
        data.completed is bool &&
        data.createdAt is number &&
        data.updatedAt is number &&
        data.updatedAt >= data.createdAt &&
        isNullableString(data.categoryId, 100);
    }

    match /tasks/{taskId} {
      allow read: if true;
      allow create: if isValidTask(request.resource.data);
      allow update: if isValidTask(request.resource.data);
      allow delete: if true;
    }
  }
}
